# 悟道 - 功能需求文档

## 1. 产品愿景

**悟道**旨在成为一款深度整合个人成长理论的数字化工具，帮助用户：

- 系统化管理人生目标（从愿景到行动）
- 科学培养持久习惯（理解触发机制）
- 记录和沉淀人生感悟（运动、工作、生活）
- 构建个人知识体系（问题与解决方案）

**核心理念**: 以终为始 + 触发机制 + 持续反思

---

## 2. 目标用户

**主要用户**: 追求自我成长的个人

- 年龄: 25-45 岁
- 职业: 知识工作者、创业者、专业人士
- 特征:
  - 阅读过《高效能人士的七个习惯》等自我管理书籍
  - 希望系统化管理人生目标
  - 需要工具支持习惯养成
  - 有记录和反思的习惯

**使用场景**:

1. 年度计划时：梳理人生愿景和年度目标
2. 每日晨间：查看今日目标和习惯清单
3. 运动后：记录运动感悟和技术心得
4. 工作中：查询知识库中的解决方案
5. 睡前：回顾今日进展，反思改进点

---

## 3. 核心功能需求

### 3.1 人生目标管理（Phase 1）

#### 3.1.1 目标层级结构

**需求描述**:  
支持 5 层目标层级，从人生愿景到具体项目：

```
人生愿景（Life）
  └─ 领域目标（Career, Health, Family, Finance, Learning）
      └─ 年度目标（2025, 2026...）
          └─ 季度目标（Q1, Q2, Q3, Q4）
              └─ 具体项目/行动（Project_X）
```

**功能要点**:

- 每个目标可以有多个子目标
- 支持跨层级查看（例如查看所有 Career 相关目标）
- 目标路径自动生成（如 `Life.Career.2025.Q1.Project_X`）
- 可折叠/展开的树形视图

**用户故事**:

```
作为用户，我希望创建「成为技术领导者」的职业目标，
并将其分解为「2025 年晋升 Tech Lead」的年度目标，
再细化为「Q1 完成系统架构设计课程」的季度目标，
以便我能清晰地看到从愿景到行动的路径。
```

#### 3.1.2 目标属性

每个目标包含以下属性：

- **基础信息**:
  - 名称（必填，最多 100 字）
  - 描述（选填，支持 Markdown，最多 1000 字）
  - 所属层级（自动识别）
  - 父目标（除顶层外必选）
  
- **状态管理**:
  - 状态: 活跃 | 已完成 | 已归档 | 暂停
  - 优先级: P1（最高）- P5（最低）
  - 进度: 0-100% （自动或手动）
  
- **时间相关**:
  - 创建时间
  - 更新时间
  - 目标截止日期（选填）
  - 完成时间（状态=已完成时自动记录）

#### 3.1.3 目标操作

**创建目标**:

- 点击「+」按钮选择父目标
- 填写名称、描述、优先级、截止日期
- 系统自动生成路径（基于父目标）
- 支持快速创建（仅名称+父目标）

**编辑目标**:

- 修改所有属性（除路径外）
- 移动到其他父目标（自动更新路径）
- 调整优先级和进度
- 添加/修改描述

**删除目标**:

- 软删除（标记为已归档）
- 提示: 删除父目标时的子目标处理
  - 选项 1: 同时归档所有子目标
  - 选项 2: 将子目标提升到上一层

**查看目标**:

- 树形视图（默认）
- 列表视图（按优先级/截止日期排序）
- 筛选: 按状态、优先级、层级筛选
- 搜索: 全文搜索目标名称和描述

#### 3.1.4 进度计算

**自动进度**（父目标）:

```
父目标进度 = Σ(子目标进度 × 子目标权重) / Σ(子目标权重)
默认权重 = 1
```

**手动进度**（叶子目标）:

- 用户直接设置 0-100%
- 支持快捷操作：0%, 25%, 50%, 75%, 100%

#### 3.1.5 UI/UX 要求

- **iOS 风格**: 使用 Cupertino 组件
- **玻璃效果**: 导航栏、底部栏使用毛玻璃效果（liquid_glass_bottom_bar）
- **底部导航**:
  - 使用 liquid_glass_bottom_bar 实现玻璃拟态效果
  - 4 个标签页：目标、习惯、灵感、我的
  - 使用 Cupertino 风格图标
  - 平滑的页面切换动画
  - 使用 Riverpod 管理选中状态
- **动画**: 目标展开/折叠使用平滑动画
- **手势**:
  - 左滑显示「编辑」「归档」按钮
  - 长按显示快捷菜单
- **空状态**: 精美的空状态插图 + 引导文案
- **加载状态**: iOS 风格的 ActivityIndicator

---

### 3.2 习惯追踪系统（Phase 2）

**核心理念**: 基于《习惯的力量》理论的习惯循环（暗示-行为-奖赏）与习惯替代机制

**技术架构**:
- 数据存储：纯本地 Drift/SQLite（Phase 2 MVP）
- 状态管理：Riverpod 3.0
- UI 风格：Cupertino（iOS 原生体验）
- 扩展性：Repository 接口预留云端同步能力（Phase 5+）

#### 3.2.1 习惯定义

**习惯循环三要素**（必填）:

- **暗示（Cue）**: 触发习惯的环境或情境信号
  - 示例："准备好书包放在一进门就能看到的椅子上"
  - 要求：越具体越好，明确的视觉/时间/情境触发条件

- **惯常行为（Routine）**: 习惯性执行的动作
  - 示例："拿起书包去图书馆"
  - 要求：可执行的具体行为描述

- **奖赏（Reward）**: 行为带来的满足感或收益
  - 示例："自律的实现让我精神满足，对自己的掌控力"
  - 要求：明确的精神或物质回报

**习惯类型**:

- **正向习惯（POSITIVE）**: 建立新的良好习惯
  - 仅需填写三要素

- **习惯替代（REPLACEMENT）**: 改变不良习惯
  - 额外字段：**原惯常行为**（被替代的旧行为）
  - 示例：暗示"无聊想刺激" → 旧行为"喝奶茶" → 新行为"喝冰酸奶" → 奖赏"享受刺激感"
  - 核心：保持相同暗示和奖赏，仅改变中间行为

**辅助属性**:

- 习惯名称（必填，最多 100 字）
- 分类标签（选填，如「学习」「健康」「工作」）
- 备注说明（选填，最多 500 字）
- 创建时间、更新时间（自动）
- 是否活跃（软删除标记）

**关联目标** (Phase 3+):

- 每个习惯可关联到一个人生目标
- 目标详情页显示相关习惯的完成情况
- 目标进度与习惯执行率联动分析

#### 3.2.2 习惯打卡

**快速打卡流程**:

1. 习惯列表页点击「打卡」按钮
2. 弹出打卡对话框（CupertinoAlertDialog）
3. 填写可选信息：
   - 执行时间（默认当前，支持调整）
   - 执行质量（1-5 星，默认 3 星）
   - 执行笔记（可选，最多 200 字）
4. 点击「确认打卡」
5. 动画反馈：✓ 图标放大 + 触觉反馈
6. 自动更新连续天数和统计数据
7. 达成里程碑时显示成就通知（如连续 7/30/100 天）

**打卡数据结构**:

- 执行时间戳（精确到分钟）
- 关联习惯 ID
- 执行质量评分（1-5 星）
- 执行笔记（可选）
- 是否补打卡标记（isBackfilled）
- 记录创建时间

**补打卡功能**:

- 支持补录过去 7 天内的打卡
- 标记为「补打卡」，与正常打卡区分
- 补打卡不计入当前连续天数（仅更新历史记录）

**今日打卡状态**:

- 已打卡：显示绿色 ✓ 标记和「已打卡」状态
- 未打卡：显示蓝色「打卡」按钮
- 使用 Provider 实时监听状态变化

#### 3.2.3 习惯统计

**核心统计指标**:

- **当前连续天数（Current Streak）**:
  - 从最近一次打卡向前回溯的连续天数
  - 算法：支持"今天或昨天"逻辑（允许隔一天仍算连续）

- **历史最佳连续天数（Best Streak）**:
  - 历史上最长的连续打卡记录
  - 显示起止日期

- **总执行次数（Total Executions）**:
  - 自创建以来的总打卡次数

- **本周执行次数（This Week）**:
  - 本周一至今的打卡次数

- **完成率（Completion Rate）**:
  - 公式：总执行次数 / 自首次打卡以来的天数
  - 百分比显示（如 85.7%）

**统计卡片展示**:

```
┌─────┬─────┬─────┬─────┐
│连续 │总计 │本周 │完成率│
│15天 │45次 │5次  │90%  │
└─────┴─────┴─────┴─────┘
```

**日历热力图**:

- GitHub 风格年度热力图
- 每个格子代表一天
- 颜色深浅映射：
  - 未打卡：灰色
  - 1-2 星：浅绿
  - 3 星：中绿
  - 4-5 星：深绿
- 支持点击查看当日详情（时间、质量、笔记）
- 支持左右滚动查看历史数据

**趋势图表** (Phase 3):

- 完成率折线图（按周/月聚合）
- 质量评分趋势图
- 最佳执行时间段分析

#### 3.2.4 次日计划功能

**核心理念**: 将习惯的「暗示」转化为次日行动计划

**生成次日计划流程**:

1. 点击「次日计划」Tab
2. 显示「从习惯生成」对话框
3. 多选要计划的习惯
4. 为每个习惯设置建议时间
5. 批量生成计划任务（将「暗示」作为任务描述）
6. 按优先级/时间排序显示

**计划任务结构**:

```
☐ 7:00 AM
  准备好书包放在一进门就能看到的椅子或桌子上
  → 关联: 去图书馆学习
  [标记完成]
```

**计划管理功能**:

- 勾选完成：标记计划为已完成
- 完成时弹出确认："暗示已完成，是否执行惯常行为并打卡？"
  - 选择「是」：跳转到打卡对话框
  - 选择「否」：仅标记计划完成
- 完成打卡后自动关联 recordId
- 支持手动删除计划
- 支持调整计划顺序（拖拽排序）

**计划与打卡关联**:

- daily_plans 表的 recordId 字段关联 habit_records
- 已关联打卡的计划显示 ✓ 图标
- 计划完成时间 completedAt 自动记录

**次日计划页面详细功能** ✅:

**1. 计划列表页面**：

- **日期切换**：今日计划 / 明日计划 分段控制器
- **计划展示**：
  - 计划卡片显示：暗示任务、关联习惯、建议时间、优先级
  - 优先级徽章：高（红色）、中（橙色）、低（无徽章）
  - 完成状态：圆圈（●未完成/○已完成）
- **智能排序**：
  - 未完成的计划排在前面
  - 相同状态按优先级排序（高→低）
- **交互操作**：
  - 点击卡片：标记完成/取消完成，弹出打卡确认对话框
  - 左滑删除：Dismissible 组件实现删除确认
  - 下拉刷新：重新加载计划列表

**2. 计划生成器对话框**：

- **习惯选择**：
  - 从活跃习惯列表中多选
  - 核心习惯（💎 标记）默认高优先级
  - 自动将习惯的「暗示」作为计划任务描述
- **时间设置**：
  - 为每个习惯设置建议执行时间
  - 使用 CupertinoDatePicker 时间选择器
  - 时间选择器高度优化为 280px 确保按钮完整显示
- **优先级设置**：
  - 三档可选：低/中/高
  - 核心习惯默认高优先级
  - 普通习惯默认中优先级
- **批量生成**：
  - 一次生成多个次日计划
  - 生成成功后自动切换到「明日计划」标签

**3. UI 设计规范**：

次日计划卡片布局：
```
┌─────────────────────────────────┐
│ ● ━━━━━━━━━━━━━━━━━━━━━━━ 高   │
│   晚饭后坐在书桌前               │
│   🔗 每天阅读                    │
│   ⏰ 19:30                       │
└─────────────────────────────────┘
```

计划生成器布局：
```
☑️ 每天运动 💎
   💡 起床后看到运动鞋
   ⏰ 建议时间: 07:00
   🚩 优先级: [低] [中] [高]
```

**4. 用户操作流程**：

```
习惯列表
  ↓ 点击右上角 "+"
创建习惯（暗示 + 惯常行为 + 奖赏）
  ↓ 保存
次日计划
  ↓ 点击右上角 "+"
选择习惯 → 设置时间 → 生成计划
  ↓ 次日
查看今日计划
  ↓ 点击计划卡片
标记完成 → 弹出打卡确认
  ↓ 完成并打卡
打卡成功 ✅
```

**5. 访问路径**：

- 习惯追踪页面 → 导航栏右上角 📅 日历图标 → 次日计划
- 导航栏按钮：
  - 📅 日历图标 - 进入次日计划页面
  - ➕ 加号图标 - 创建新习惯

**计划定时提醒功能**（待实现 - Phase 3+）:

**需求描述**：
为次日计划添加定时通知提醒功能，帮助用户在合适的时间执行计划

**功能要点**：

- **智能提醒时间**：根据计划的 scheduledTime 发送本地通知
- **提前提醒设置**：用户可配置提前提醒时间
  - 准时提醒
  - 提前 5 分钟
  - 提前 10 分钟
  - 提前 15 分钟
- **通知管理**：
  - 支持全局通知开关
  - 支持免打扰时段设置（如 22:00-8:00）
  - 支持单个计划禁用提醒
- **通知交互**：
  - 点击通知直接进入计划详情页
  - 通知中显示计划任务和关联习惯
  - 支持通知栏快捷操作（标记完成/稍后提醒）

**技术方案**：

- **跨平台通知**：使用 `flutter_local_notifications` 包
- **iOS 实现**：使用 `UNUserNotificationCenter` API
- **Android 实现**：使用 `AlarmManager` + `NotificationManager`
- **通知调度**：
  - 创建计划时自动注册通知
  - 更新计划时间时重新调度通知
  - 完成计划时自动取消通知
  - 删除计划时清理相关通知
- **权限处理**：
  - 首次使用时请求通知权限
  - 权限被拒绝时显示引导说明
  - 设置页面提供跳转系统设置的入口

**数据扩展**：

- daily_plans 表新增字段：
  - `reminderEnabled`: 是否启用提醒（boolean）
  - `reminderMinutesBefore`: 提前提醒分钟数（integer，nullable）

**优先级**：中
**预估工时**：2-3 天
**依赖条件**：次日计划基础功能完成

#### 3.2.5 Frontmatter 习惯感悟

**功能定位**: 记录习惯养成过程中的长期感悟和体会

**内容结构**:

```yaml
---
title: 习惯的力量
created: 2024-01-01
updated: 2024-10-04
tags: [自律, 成长, 习惯养成]
---

# 我的习惯感悟

习惯具有强大的主导力，不可抵抗的力量...

## 已内化的习惯
1. **去图书馆的习惯**
   - 即使下雨、即使便秘10点也要坚持
   - 已经成为我的一部分

## 习惯带来的改变
- 自律的实现让我精神满足
- 对自己的掌控力显著提升
```

**编辑功能**:

- Markdown 编辑器（使用 flutter_markdown）
- YAML frontmatter 编辑（标题、标签、时间）
- 预览模式 / 编辑模式切换
- 自动保存草稿（离开页面前提示）
- 支持插入图片（本地存储）

**标签系统**:

- 支持多标签（如「自律」「成长」「坚持」）
- 标签选择器（输入或选择已有标签）
- 按标签筛选感悟

**时间线展示**:

- 按更新时间倒序排列
- 显示创建/更新时间
- 与习惯关联显示（Phase 3+）

#### 3.2.6 UI/UX 要求

**iOS 原生风格**:

- 使用 Cupertino 组件（CupertinoPageScaffold、CupertinoListSection）
- 毛玻璃导航栏（BackdropFilter + blur）
- 左滑显示编辑/删除按钮（Dismissible）
- 长按显示快捷菜单
- 触觉反馈（打卡成功时震动）

**动画反馈**:

- 打卡成功：✓ 图标放大动画 + 触觉反馈
- 连续天数更新：数字滚动动画
- 成就达成：弹窗 + 礼花动画（连续 7/30 天）
- 页面切换：CupertinoPageRoute 自然过渡

**空状态设计**:

- 精美插图（简洁图标 + 柔和色彩）
- 引导文案："还没有习惯，点击右上角 + 添加你的第一个习惯"
- 添加示例习惯按钮（可选）

**错误处理**:

- 网络错误：友好提示"暂时无法同步，已保存到本地"（Phase 5+ 云端同步）
- 数据库错误：记录日志 + 通用错误提示
- 表单验证：实时提示 + 红色边框标记

**性能要求**:

- 打卡操作响应时间 < 500ms
- 列表滚动流畅 60fps
- 热力图渲染时间 < 1 秒
- 统计计算在后台线程执行（防止阻塞 UI）

#### 3.2.7 数据隐私与安全

**本地数据保护**:

- 所有习惯数据存储在本地 SQLite 数据库
- 敏感字段可选 AES-256 加密（Phase 3+）
- 应用锁功能（生物识别解锁，Phase 4+）

**数据备份** (Phase 3+):

- 导出为 JSON 格式
- 导出为 Markdown 格式（含 Frontmatter）
- iCloud 自动备份（iOS）
- 本地文件备份

**无第三方分析**:

- 不使用 Google Analytics 等追踪工具
- 不收集用户行为数据
- 完全离线可用（Phase 2）

---

### 3.3 灵感记录与反思（Phase 3）

#### 3.3.1 反思类型

**运动反思**:

- 活动类型（羽毛球/网球/健身/跑步）
- 技术要点（如您提供的例子）
- 感悟与改进
- 关联视频/图片

**工作反思**:

- 项目名称
- 遇到的问题
- 解决方案
- 经验教训
- 关联目标

**生活反思**:

- 事件描述
- 情绪记录
- 思考与感悟
- 行动计划

#### 3.3.2 记录界面

**创建反思**:

- 选择类型（自动显示对应模板）
- 富文本编辑器（支持 Markdown）
- 图片/视频上传
- 标签系统
- 关联目标（可选）

**查看反思**:

- 时间线视图（按时间倒序）
- 网格视图（卡片式）
- 筛选: 按类型、标签、目标筛选
- 搜索: 全文搜索

---

### 3.4 知识库系统（Phase 4）

#### 3.4.1 知识条目

**属性**:

- 标题
- 内容（Markdown）
- 类型: 问题 | 解决方案 | 笔记 | 资源
- 分类（可自定义）
- 标签（多个）
- 来源（如某本书、某课程）

**关联**:

- 关联到目标
- 引用其他知识条目
- 附件（PDF/图片/链接）

#### 3.4.2 搜索功能

**全文搜索**:

- 搜索标题和内容
- 高亮显示匹配词
- 按相关度排序

**高级搜索**:

- 按分类、标签组合筛选
- 按创建/更新时间筛选
- 收藏的内容

---

## 4. 非功能需求

### 4.1 性能要求

- **启动时间**: < 2 秒（冷启动）
- **页面切换**: < 300ms（流畅 60fps）
- **数据加载**: < 1 秒（网络正常情况）
- **离线响应**: 即时（0 延迟）
- **同步速度**: < 5 秒（增量同步）

### 4.2 可用性要求

- **学习曲线**: 首次使用 < 5 分钟上手核心功能
- **操作效率**: 创建一个目标 < 30 秒
- **错误恢复**: 所有操作可撤销/恢复
- **引导帮助**: 首次使用有引导流程

### 4.3 兼容性要求

- **iOS**: 16.0+
- **macOS**: 13.0+
- **Android**: 10.0+ (API Level 29+)
- **Web**: 现代浏览器（Chrome/Safari/Edge 最新两个版本）

### 4.4 安全性要求

- **数据传输**: HTTPS/TLS 1.3
- **数据存储**:
  - 敏感字段 AES-256 加密
  - 本地 SQLite 数据库加密（SQLCipher）
- **认证**:
  - Phase 1: API Key（SHA256 哈希）
  - Phase 5: JWT Token（24小时过期）
- **隐私**:
  - 所有数据自托管
  - 无第三方分析工具
  - 无广告

### 4.5 可维护性要求

- **代码质量**:
  - Dart Analyzer 0 警告
  - Go lint 通过
  - 测试覆盖率 > 60%
- **文档**:
  - API 有完整 Swagger 文档
  - 代码有充分注释
  - README 和用户手册完整
- **日志**:
  - 分级日志（Debug/Info/Error）
  - 错误追踪（崩溃报告）

### 4.6 开发环境要求

- **Flutter 版本管理**:
  - 使用 FVM 管理 Flutter 版本
  - VS Code 配置 `"dart.flutterSdkPath": ".fvm/flutter_sdk"` 使用符号链接
  - 避免使用相对路径 `.fvm/versions/x.x.x`（可能导致 Dart 扩展无法识别）
  - 修改配置后重启 Dart Analysis Server

- **macOS 平台配置**:
  - 调试模式需要网络权限：
    - `DebugProfile.entitlements` 添加 `network.server` 和 `network.client`
    - `Release.entitlements` 添加 `network.client`
  - 修改 entitlements 后执行 `flutter clean`
  - VS Code 调试配置需要正确的 SDK 路径

- **开发工具**:
  - VS Code 或 Android Studio + Dart/Flutter 插件
  - Docker Desktop（用于 PostgreSQL）
  - Postman 或 Swagger UI（用于 API 测试）
  - Git（版本控制）

---

## 5. 约束条件

### 5.1 技术约束

- **前端**: 必须使用 Flutter 3.35+
- **后端**: 必须使用 Go 1.23+
- **数据库**: 必须使用 PostgreSQL 16+
- **部署**: 必须支持 Docker Compose

### 5.2 资源约束

- **开发时间**: Phase 1 必须在 6 周内完成
- **预算**: 自托管，无云服务费用
- **人力**: 1 名全栈开发者（您）+ AI 助手

### 5.3 业务约束

- **用户规模**: Phase 1-4 仅个人使用
- **数据量**:
  - 目标: < 500 个
  - 习惯: < 50 个
  - 反思: < 5000 条
  - 知识库: < 1000 条

---

## 6. 未来规划（Phase 5+）

### 6.1 高级分析功能

- **目标达成率分析**: 各领域目标完成情况对比
- **习惯相关性分析**: 发现哪些习惯组合效果最好
- **时间分配分析**: 在各目标上投入的时间统计
- **趋势预测**: 基于历史数据预测目标完成可能性

### 6.2 协作功能

- **多用户支持**: 用户注册和登录
- **目标分享**: 分享目标给他人查看
- **习惯挑战**: 和朋友一起培养习惯
- **导师模式**: 邀请导师查看和指导

### 6.3 集成功能

- **日历集成**: 与 iOS/Google 日历同步目标和习惯
- **健康数据**: 读取 Apple Health 运动数据
- **通知系统**: 基于触发机制的智能提醒
- **导出导入**: 支持多种格式（PDF/Markdown/JSON）

### 6.4 AI 增强

- **智能建议**: AI 根据目标推荐习惯
- **反思总结**: AI 生成周/月反思报告
- **知识关联**: AI 自动关联相关知识条目
- **问答系统**: 基于个人知识库的 AI 问答

---

## 7. 验收标准

### Phase 1 验收标准

✅ **功能完整性**:

- [ ] 可以创建 5 层层级目标
- [ ] 目标 CRUD 所有操作正常
- [ ] 进度自动计算准确
- [ ] 目标筛选和搜索有效

✅ **用户体验**:

- [ ] iOS 风格 UI 美观流畅
- [ ] 离线操作即时响应
- [ ] 在线同步无感知
- [ ] 错误提示友好清晰

✅ **技术指标**:

- [ ] 启动时间 < 2 秒
- [ ] 页面切换流畅 60fps
- [ ] 测试覆盖率 > 60%
- [ ] 0 严重 Bug

✅ **部署就绪**:

- [ ] Docker Compose 一键启动
- [ ] API 文档完整
- [ ] 用户手册可用
- [ ] 数据备份方案就绪

---

## 8. 附录

### 8.1 用户故事地图

```
用户旅程: 设定和追踪年度目标

1. 新年规划
   - 创建年度愿景
   - 分解到各领域
   - 设定关键指标

2. 季度计划
   - 创建季度目标
   - 分解具体项目
   - 估算时间和优先级

3. 日常执行
   - 查看今日目标
   - 更新进度
   - 记录反思

4. 定期回顾
   - 查看完成情况
   - 分析问题原因
   - 调整下阶段目标
```

### 8.2 术语表

- **人生愿景**: 最高层级的长期目标（通常是 5-10 年的期望）
- **领域目标**: 人生各重要领域的目标（事业、健康、家庭等）
- **触发机制**: 启动习惯行为的外部或内部信号
- **连续打卡**: 习惯连续完成的天数
- **离线优先**: 先操作本地数据，再同步到云端的架构模式
- **ltree**: PostgreSQL 扩展，用于存储和查询层级数据

---

**文档版本**: v1.0  
**最后更新**: 2025-10-01  
**维护者**: 项目团队
