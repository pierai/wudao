# 次日计划 - 用户使用指南

> 基于《习惯的力量》理论，帮助你提前规划次日的暗示任务，让好习惯自然发生

---

## 📍 访问路径

**习惯追踪页面 → 导航栏右上角 📅 日历图标 → 次日计划**

导航栏现在有两个按钮：
- **📅 日历图标** - 进入次日计划页面
- **➕ 加号图标** - 创建新习惯

---

## 🎯 核心功能

### 1. 次日计划列表页面

**功能特性**：

- **📅 日期切换**：今日计划 / 明日计划 分段控制器
- **✅ 计划完成**：点击卡片标记完成，弹出打卡确认对话框
- **🔗 习惯关联**：显示关联的习惯名称（异步加载）
- **⏰ 建议时间**：显示计划的建议执行时间
- **🚩 优先级标识**：高/中/低优先级徽章
- **🗑️ 左滑删除**：Dismissible 删除计划
- **📊 智能排序**：未完成排前面 + 按优先级排序

**界面示例**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃  次日计划              📅  ➕  ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃  ┌───────────────────────┐  ┃
┃  │  今日计划  │  明日计划  │  ┃
┃  └───────────────────────┘  ┃
┃                              ┃
┃  ● ━━━━━━━━━━━━━━━━━━━ 高  ┃
┃    晚饭后坐在书桌前          ┃
┃    🔗 每天阅读               ┃
┃    ⏰ 19:30                  ┃
┃                              ┃
┃  ○ ━━━━━━━━━━━━━━━━━━━ 中  ┃
┃    午饭时看到食堂            ┃
┃    🔗 健康饮食               ┃
┃    ⏰ 12:00                  ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2. 计划生成器对话框

**功能特性**：

- **☑️ 多选习惯**：从活跃习惯列表中选择
- **💎 核心习惯优先**：核心习惯默认高优先级
- **⏰ 时间选择器**：为每个计划设置建议时间
- **🚩 优先级设置**：低/中/高 三档可选
- **📝 暗示转任务**：自动将习惯的"暗示"作为计划任务
- **🎯 批量生成**：一次生成多个次日计划

**界面示例**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃  生成次日计划          取消 生成 ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃                              ┃
┃  ☑️ 每天运动 💎               ┃
┃     💡 起床后看到运动鞋       ┃
┃     ⏰ 建议时间: 07:00        ┃
┃     🚩 优先级: [低] [中] [高] ┃
┃                              ┃
┃  ☐ 健康饮食                  ┃
┃     💡 午饭时看到食堂         ┃
┃     ⏰ 建议时间: 12:00        ┃
┃     🚩 优先级: [低] [中] [高] ┃
┃                              ┃
┃  ☑️ 每天阅读                 ┃
┃     💡 晚饭后坐在书桌前       ┃
┃     ⏰ 建议时间: 19:30        ┃
┃     🚩 优先级: [低] [中] [高] ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 3. 计划与打卡关联逻辑 ✅

**智能提示流程**：

当你点击计划卡片标记完成时，系统会弹出确认对话框：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃          完成计划              ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┃                              ┃
┃  暗示"晚饭后坐在书桌前"已完成 ┃
┃  是否执行惯常行为并打卡？    ┃
┃                              ┃
┃  ┌─────────┐  ┌────────────┐ ┃
┃  │仅标记完成│  │完成并打卡  │ ┃
┃  └─────────┘  └────────────┘ ┃
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**功能说明**：
- **仅标记完成**：只标记暗示任务完成，不记录习惯打卡
- **完成并打卡**：标记完成 + 自动打开打卡对话框（预留功能，待实现）
- **数据关联**：预留 `recordId` 字段关联打卡记录

---

## 🔄 完整用户流程

### 从零开始的完整操作

```
习惯列表
  ↓ 点击右上角 "+"
创建习惯（暗示 + 惯常行为 + 奖赏）
  ↓ 保存
次日计划
  ↓ 点击右上角 "+"
选择习惯 → 设置时间 → 生成计划
  ↓ 明天到来
查看今日计划
  ↓ 点击计划卡片
标记完成 → 弹出打卡确认
  ↓ 选择"完成并打卡"
打卡成功 ✅
```

### 详细步骤说明

#### 第一步：创建习惯

1. 在**习惯追踪**页面，点击右上角 **➕**
2. 填写习惯信息：
   - 习惯名称：例如 "每天阅读"
   - **暗示**：例如 "晚饭后坐在书桌前"（这个很重要！）
   - 惯常行为：例如 "阅读 30 分钟"
   - 奖赏：例如 "精神满足感"
3. 保存习惯

#### 第二步：生成次日计划

1. 点击右上角 **📅** 进入次日计划页面
2. 切换到 **明日计划** 标签
3. 点击右上角 **➕** 打开计划生成器
4. 选择要执行的习惯（可多选）：
   - **核心习惯**（💎 标记）会自动设为高优先级
   - 普通习惯默认中优先级
5. 为每个习惯设置：
   - **⏰ 建议时间**：点击时间选择器，选择预计执行时间
   - **🚩 优先级**：根据重要性选择 低/中/高
6. 点击 **生成** 按钮
7. 系统会自动将习惯的**暗示**作为明日计划的任务

#### 第三步：执行计划

1. 次日打开应用，进入次日计划页面
2. 切换到 **今日计划** 标签
3. 查看按优先级排序的计划列表
4. 当你完成某个暗示任务时：
   - 点击对应的计划卡片
   - 在弹出的对话框中选择：
     - **仅标记完成**：只标记任务完成
     - **完成并打卡**：标记完成并记录习惯执行（推荐）
5. 如果选择"完成并打卡"：
   - 会打开打卡对话框（待实现）
   - 可以记录执行质量（1-5 星）
   - 可以添加执行笔记

#### 第四步：管理计划

- **删除计划**：左滑计划卡片，点击删除
- **查看历史**：切换日期标签查看今日/明日计划
- **修改优先级**：删除后重新生成（后续可优化为直接编辑）

---

## 💡 使用技巧

### 1. 如何设置有效的暗示？

**好的暗示应该**：
- ✅ 具体明确："晚饭后坐在书桌前"
- ✅ 容易触发："看到书包"
- ✅ 有时间地点："起床后看到运动鞋"

**避免模糊的暗示**：
- ❌ "想起来的时候"
- ❌ "有空的时候"
- ❌ "心情好的时候"

### 2. 优先级如何设置？

**高优先级**（红色徽章）：
- 核心习惯（会带动其他习惯）
- 时间敏感的任务
- 对当天影响最大的习惯

**中优先级**（橙色徽章）：
- 重要但不紧急的习惯
- 日常维持性习惯

**低优先级**（无徽章）：
- 可选的习惯
- 不确定能否完成的习惯

### 3. 最佳实践

**每日计划数量**：
- 🎯 建议 3-5 个计划最佳
- ⚠️ 超过 8 个可能导致执行困难

**时间设置**：
- 根据你的日程安排设置建议时间
- 未来可以设置提醒通知（待实现）

**核心习惯优先**：
- 优先规划核心习惯（💎 标记）
- 核心习惯执行后会自然带动其他习惯

---

## 🎨 UI 设计亮点

### 计划卡片设计

```
┌─────────────────────────────────┐
│ ● ━━━━━━━━━━━━━━━━━━━━━━━ 高   │
│   晚饭后坐在书桌前               │
│   🔗 每天阅读                    │
│   ⏰ 19:30                       │
└─────────────────────────────────┘
```

**视觉元素**：
- **●/○ 圆圈**：未完成/已完成状态
- **━ 分隔线**：增强视觉层次
- **🚩 优先级徽章**：高（红）/中（橙）/低（无）
- **🔗 习惯关联**：显示关联的习惯名称
- **⏰ 时间标识**：建议执行时间

### 交互反馈

- **点击卡片**：标记完成 → 弹出确认对话框
- **左滑卡片**：显示删除按钮 → 确认删除
- **下拉刷新**：重新加载计划列表
- **自动切换**：生成计划后自动切换到"明日计划"标签

---

## ⚙️ 技术实现细节

### 数据模型

**DailyPlan 实体**：

```dart
@freezed
sealed class DailyPlan with _$DailyPlan {
  const factory DailyPlan({
    required String id,
    required String habitId,
    required String cueTask,        // 暗示任务
    required DateTime plannedDate,  // 计划日期
    DateTime? scheduledTime,        // 建议时间
    required int priority,          // 优先级 1-10
    required bool isCompleted,      // 是否完成
    String? recordId,               // 关联的打卡记录 ID（可选）
    DateTime? completedAt,          // 完成时间
  }) = _DailyPlan;
}
```

### 核心功能

**1. 按日期查询计划**：

```dart
final plansAsync = ref.watch(plansByDateProvider(date));
```

**2. 智能排序**：

- 未完成的计划排前面
- 相同状态按优先级排序（高 → 低）

**3. 计划完成逻辑**：

```dart
Future<void> _handleCompletePlan(DailyPlan plan) async {
  if (plan.isCompleted) {
    // 已完成，取消完成
    await repository.uncompleteDailyPlan(plan.id);
  } else {
    // 未完成，询问是否打卡
    final shouldCheckIn = await showCupertinoDialog<bool>(...);

    if (shouldCheckIn == true) {
      // TODO: 打开打卡对话框
      await repository.completeDailyPlan(plan.id, recordId);
    } else if (shouldCheckIn == false) {
      // 仅标记完成
      await repository.completeDailyPlan(plan.id, null);
    }
  }
}
```

---

## 🔮 未来规划

### Phase 3+ 功能（待实现）

**计划定时提醒功能**：

- **智能提醒时间**：根据 `scheduledTime` 发送本地通知
- **提前提醒设置**：准时/5分钟/10分钟/15分钟
- **免打扰时段**：例如 22:00-8:00 不发送通知
- **通知交互**：
  - 点击通知直接进入计划详情页
  - 通知栏快捷操作（标记完成/稍后提醒）

**技术方案**：
- 使用 `flutter_local_notifications` 包
- iOS: `UNUserNotificationCenter` API
- Android: `AlarmManager` + `NotificationManager`

**数据扩展**：

```dart
// daily_plans 表新增字段
reminderEnabled: boolean      // 是否启用提醒
reminderMinutesBefore: int?   // 提前提醒分钟数
```

详见：[`requirements.md`](../requirements.md) - 3.2.4 节

---

## 📖 相关文档

- **完整需求文档**：[`habit_module_requirements.md`](../habit_module_requirements.md)
- **快速开始指南**：[`HABIT_QUICK_START.md`](./HABIT_QUICK_START.md)
- **开发计划**：[`PLAN.md`](../../PLAN.md) - Phase 2, Week 3
- **项目需求**：[`requirements.md`](../requirements.md) - 3.2.4 节

---

## ❓ 常见问题

**Q: 为什么计划要基于"暗示"而不是"惯常行为"？**

A: 根据《习惯的力量》理论，**暗示是触发习惯的关键**。提前规划暗示任务，可以：
- 让你更容易记住要做的事
- 降低执行阻力（看到暗示自然触发行为）
- 提高习惯养成成功率

**Q: 如何删除或修改计划？**

A:
- **删除**：左滑计划卡片，点击删除按钮
- **修改**：目前需要删除后重新生成（后续会优化为直接编辑）

**Q: 计划完成后一定要打卡吗？**

A: 不一定。你可以选择：
- **仅标记完成**：只标记暗示任务完成，不记录习惯执行
- **完成并打卡**：推荐！可以记录执行质量和笔记

**Q: 为什么生成计划后看不到？**

A: 新生成的计划默认是"明日计划"，系统会自动切换到"明日计划"标签。如果没有自动切换，请手动切换。

**Q: 可以为同一个习惯生成多个计划吗？**

A: 目前不支持。每个习惯每天只能生成一个计划。如果需要多次执行，建议：
- 创建多个相似习惯（例如"晨跑"和"晚跑"）
- 或者手动多次打卡同一个习惯

---

**最后更新**: 2025-10-05
**功能状态**: ✅ 已实现（打卡集成待完善）

**现在就开始规划你的次日计划吧！** 🎯
