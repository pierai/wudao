# 次日计划交互优化需求总结

## 📋 快速概览

### 核心问题

当前次日计划的"暗示完成"和"习惯打卡"边界不清晰,需要通过状态机模型明确状态流转规则。

### 解决方案

引入 4 种状态:
- `pending` (⏳ 待执行)
- `cueCompleted` (✅ 暗示已完成,未打卡)
- `checkedIn` (✅ 已打卡)
- `skipped` (⚠️ 已跳过,在习惯列表直接打卡)

### 关键决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 明日计划是否允许操作? | **只读** | 明天还没到,不应提前完成暗示 |
| 习惯列表打卡后,计划状态? | **skipped** | 保留记录,分析"暗示触发率" |
| 补打卡入口放哪? | **卡片按钮** | 最直观,减少操作步骤 |
| 重复打卡处理? | **完全阻止** | 符合"一天一次"理念 |
| 点击卡片默认行为? | **标记暗示完成** | 减少步骤,自动显示"打卡"按钮 |

## 🔄 状态流转图

```
              用户操作
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│ pending │  │ pending │  │ pending │
│ (待执行) │  │ (待执行) │  │ (待执行) │
└────┬────┘  └────┬────┘  └────┬────┘
     │            │            │
     │点击卡片     │点击卡片     │习惯列表
     │            │+立即打卡    │直接打卡
     ▼            ▼            ▼
┌──────────────┐ ┌─────────┐  ┌─────────┐
│cueCompleted  │ │checkedIn│  │ skipped │
│(暗示已完成)   │ │(已打卡) │  │(已跳过) │
└──────┬───────┘ └─────────┘  └─────────┘
       │                            ↑
       │点击"打卡"按钮                │
       │                            │
       ▼                            │
   ┌─────────┐                      │
   │checkedIn│──────────────────────┘
   │(已打卡) │  同时标记计划为 skipped
   └─────────┘
       │
       │取消打卡
       ▼
   ┌──────────────┐
   │cueCompleted  │
   │(暗示已完成)   │
   └──────────────┘
```

## 🎨 UI 交互设计

### 今日计划 - 4 种状态

#### 1. pending (待执行)
```
┌────────────────────────────────────┐
│ ○  准备好书包放在椅子上              │  ← 空心圆圈
│    🔗 图书馆学习                    │
│    🕐 08:00            [高]         │
└────────────────────────────────────┘
```
**交互**: 点击卡片 → 标记暗示完成

---

#### 2. cueCompleted (暗示已完成)
```
┌────────────────────────────────────┐
│ ✓  准备好书包放在椅子上  [打卡]     │  ← 绿色勾 + 打卡按钮
│    🔗 图书馆学习                    │
│    🕐 08:00            [高]         │
└────────────────────────────────────┘
```
**交互**:
- 点击卡片 → 取消暗示完成
- 点击"打卡"按钮 → 弹出打卡对话框

---

#### 3. checkedIn (已打卡)
```
┌────────────────────────────────────┐
│ ✓  准备好书包放在椅子上  [已打卡]   │  ← 绿色勾 + 已打卡徽章
│    🔗 图书馆学习                    │
│    🕐 08:00  ⭐⭐⭐⭐⭐  [高]       │  ← 显示质量星级
└────────────────────────────────────┘
```
**交互**: 点击卡片 → 取消打卡(状态 → cueCompleted)

---

#### 4. skipped (已跳过)
```
┌────────────────────────────────────┐
│ ⚠️  准备好书包放在椅子上  [已跳过]  │  ← 删除线 + 灰色文字
│    🔗 图书馆学习 (已在列表打卡)     │
│    🕐 08:00            [高]         │
└────────────────────────────────────┘
```
**交互**: 点击无响应(状态不可逆)

---

### 明日计划 - 只读状态

```
┌────────────────────────────────────┐
│ ○  准备好书包放在椅子上 (明天执行) │  ← 置灰,透明度 0.6
│    🔗 图书馆学习                    │
│    🕐 08:00            [高]         │
└────────────────────────────────────┘
```
**交互**: 点击无响应或弹出提示:"明天才能执行此计划"

---

### 习惯列表 - 打卡状态

#### 未打卡
```
┌────────────────────────────────────┐
│ 图书馆学习              [打卡]      │
│ 暗示: 准备好书包                   │
│ 连续 5 天 · 完成率 80%              │
└────────────────────────────────────┘
```

#### 已打卡
```
┌────────────────────────────────────┐
│ 图书馆学习              [已打卡]    │  ← 按钮禁用
│ 暗示: 准备好书包                   │
│ 连续 5 天 · 完成率 80%              │
│ 今日 ⭐⭐⭐⭐⭐ 10:30              │  ← 显示打卡信息
└────────────────────────────────────┘
```

## 📊 数据模型变更

### DailyPlan 新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `status` | `PlanCompletionStatus` | 计划状态(pending/cueCompleted/checkedIn/skipped) |
| `recordId` | `String?` | 关联的打卡记录 ID |
| `cueCompletedAt` | `DateTime?` | 暗示完成时间 |
| `checkedInAt` | `DateTime?` | 打卡时间 |

### HabitRecord 新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `source` | `RecordSource` | 打卡来源(fromPlan/fromList) |
| `planId` | `String?` | 如果来自计划,记录计划 ID |

## 🔧 实现步骤

### Phase 1: 数据层改造 (2h)
- 修改实体和数据库表
- 编写迁移脚本
- 测试旧数据兼容性

### Phase 2: 业务逻辑 (3h)
- 扩展 Repository 接口
- 实现状态流转逻辑
- 实现双向同步
- 单元测试

### Phase 3: UI 重构 (3h)
- DailyPlanScreen 交互优化
- PlanCard 组件重构
- HabitCard 组件优化

### Phase 4: 测试与优化 (2h)
- Widget 测试
- 集成测试(6 个场景)
- 性能优化
- UI 细节打磨

### Phase 5: 文档更新 (1h)
- 更新 FAQ.md
- 更新用户指南
- 更新 PLAN.md

**总计**: 11 小时

## ✅ 验收标准

- [ ] 状态流转正确(4 个场景测试通过)
- [ ] 数据同步准确(习惯列表 ↔ 次日计划)
- [ ] 防重复打卡生效
- [ ] 明日计划只读
- [ ] UI 状态清晰,交互流畅
- [ ] 数据库迁移成功,旧数据兼容

## 📚 相关文档

- **完整需求**: [`daily_plan_interaction_requirements.md`](./daily_plan_interaction_requirements.md)
- **开发计划**: [`../../PLAN.md`](../../PLAN.md#task-222-次日计划状态机重构-)
- **用户指南**: [`../habit/DAILY_PLAN_USER_GUIDE.md`](../habit/DAILY_PLAN_USER_GUIDE.md)
- **FAQ**: [`../FAQ.md`](../FAQ.md#q1)

---

**版本**: v1.0.0
**创建日期**: 2025-10-05
**负责人**: @flutter_architect
